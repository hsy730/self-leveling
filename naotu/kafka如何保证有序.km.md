# kafka如何保证有序

## Producer

### 主线程

#### 创建消息

#### 拦截器

#### 序列化器

#### 分区器

##### 默认配置

###### 消息键值为 null

####### 使用轮询（Round Robin）算法决定分区归属

###### 消息键值不为空

####### 对键进行散列（Hash）的方式来决定分区归属。

#### 消息累加器

##### 作用：批量累积消息 

###### 将多个小消息合并成一个更大的批次（Batch）

###### 目的：从而减少网络请求次数，提高吞吐量。

### sender线程

#### 发送消息至kafka broker

##### 1. 从消息累加器读取消息

##### 2. 封装request对象

###### 打包发送消息的载体

##### 3. 缓存至InFlightRequests

###### 作用：存放的是已经发出去、但还没有收到响应的Request对象，默认值为5

###### 限制条件：一旦超出这个阈值，Producer就不会再往这个Broker节点发送请求了。

###### 目的：防止消息发送密集而导致Broker节点的负载过高。

### 参数

#### max.in.flight.requests.per.connection

##### 该参数作用于InFlightRequests缓存区域，用来设置Producer在收到Broker响应之前，可以发送几个批次的消息，默认值为5。

#### retries

##### 设置当Producer发送消息失败时，可以进行重试的次数，默认值为0，也就是不进行重试。

#### 【特别注意】

##### 为保证发送消息有序，生产者端的max.in.flight.requests.per.connection和retries这两个参数必须得有一个等于0

###### 原因： 如果我们将retries参数值设置为1，在max.in.flight.requests.per.connection的参数值大于1的情况下，Request1批次的消息发送失败，Request2批次的消息发送成功，此时Request1批次的消息进行重试发送也成功了，那两者的顺序就反过来了。

## Consumer

### 参数

#### max.poll.records

## 有序性

### 业务有序性

#### 保证某一个订单（设备等）的所有操作有序。

##### key使用同一个， 消息默认发送到同一个分区

### 全局有序性

#### 所有的消息都有序

##### 只建一个分区

### 单线程消费
